(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{493:function(t,e,n){"use strict";n.r(e);var a=n(2),s=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("全局全序"),e("br"),t._v("\n每个客户端看到相同的顺序"),e("br"),t._v("\nas if one copy of data, and a linear sequence of operations applied to the data.")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("**example 1**  \n|===wx1===|   |===wx2===|  \n       |===rx2===|  \n         |=rx1=|\nexists a linear order:  wx1  rx1 wx2 rx2\n\n**example 2**  \n|===wx1===|   |===wx2===|  \n       |===rx2===|  \n                     |=rx1=|\nnot linear\n\n**example 3**  \n|===wx0===|    |===wx1===|  \n                 |===wx2===|\n           |===rx2===|  |===rx1===|          \n           |===rx1===|  |===rx2===|  \nnot linear  \n\n**example 4**  \n|===wx1===|   \n             |===wx2===|  \n                          |===rx1===|\nnot linera\n\n**example 5**  \n|===wx3===|     |===wx4===|  \n            |==rx=======                         //request lost or reply lost or leader fail   \n重传会导致不同的线性一致性问题\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br"),e("span",{staticClass:"line-number"},[t._v("25")]),e("br"),e("span",{staticClass:"line-number"},[t._v("26")]),e("br"),e("span",{staticClass:"line-number"},[t._v("27")]),e("br"),e("span",{staticClass:"line-number"},[t._v("28")]),e("br"),e("span",{staticClass:"line-number"},[t._v("29")]),e("br")])]),e("p",[t._v("Linearizability")]),t._v(" "),e("ol",[e("li",[t._v("exists one and only total order ops")]),t._v(" "),e("li",[t._v("matches real time")]),t._v(" "),e("li",[t._v("reads see perceeding write in the order")])]),t._v(" "),e("p",[t._v("why ZK?")]),t._v(" "),e("ol",[e("li",[t._v("API general-purpose coord service")]),t._v(" "),e("li",[t._v("Nx - Nx performance")])]),t._v(" "),e("p",[t._v("zk不保证线性一致性，可能返回旧数据."),e("br"),t._v("\n写请求是线性一致的。\n任何一个客户端的请求，都会按照客户端指定的顺序来执行")]),t._v(" "),e("p",[t._v("每个成功的请求会回复一个zxid， 即使切换副本，也会保证不会读到之前的数据")]),t._v(" "),e("p",[t._v("zookeeper的FIFO属性\n例子：")]),t._v(" "),e("ol",[e("li",[t._v("比如一个客户端在一个副本读到 index = 5的数据，但是这个副本故障了，换了另一个副本，那么接下来的读至少要从 index = 5开始.")]),t._v(" "),e("li",[t._v("比如一个客户端写一个一条数据 index = 5的数据，之后的读请求也必须从 index = 5开始")])]),t._v(" "),e("p",[t._v("同步操作是一个写操作，返回最新的zxid，然后再读就可以读到“最新”的数据了。")]),t._v(" "),e("p",[e("strong",[t._v("ready file")])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("时间")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("write order")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("read order")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v('delete("ready")')]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("write file1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("3")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("write file2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("4")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v('create("ready")')]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("5")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v('exist("ready")')])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("6")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("read file1")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("7")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("read file2")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("8")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v('exist("ready")')])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("9")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v('delete("ready")')]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("10")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("read file1")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("11")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("write file1")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("12")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("write file2")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("13")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}}),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("read file")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[t._v("14")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v('create("ready")')]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}})])])]),t._v(" "),e("p",[t._v("10-13的读会读到旧的file1和新的file2"),e("br"),t._v('\n解决发案，建立ready file的watch，如果删除给客户端通知, 即exist("ready", watch = true)'),e("br"),t._v("\n也就是说，先执行通知客户端，再进行删除操作。也就是，客户端读取配置读了一半，如果收到了ready file删除的通知，就可以放弃这次读，再重试读。")]),t._v(" "),e("p",[t._v("znode")]),t._v(" "),e("ol",[e("li",[t._v("regular znodes, 一旦创建，永久存在，除非删除")]),t._v(" "),e("li",[t._v("ephemeral znodes. 如果zookeeper认为创建它的客户端挂了，它会删除这种类型的znode. 这种类型的znode与客户端会话绑定，所以客户端需要通过心跳告诉zookeeper自己还活着，这样zookeeper才不会删除客户端对应的ephemeral znodes。")]),t._v(" "),e("li",[t._v("sequential znode. 当你想要一个特定的名字创建一个文件，zookeeper实际上创建的文件名是你指定的文件名再加上一个数字。当有多个客户端创建sequential文件时，zookeeper会保证这里的数字不重合，同时也会保证这里的数字是递增的。")])]),t._v(" "),e("p",[t._v("create(path, data, flag), path：路径，data：数据，flag：znode类型。create的语义是排他的，如果返回值是yes，说明之前该文件不存在，如果是no或者错误，说明该文件存在。")]),t._v(" "),e("p",[t._v("mini-transaction与数据库中的乐观锁差不多")]),t._v(" "),e("p",[t._v("创建非扩展锁")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('WHILE TRUE:\n    IF CREATE("f", data, ephemeral=TRUE): RETURN\n    IF EXIST("f", watch=TRUE):\n        WAIT\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("p",[t._v("羊群效应，需要对watch的客户端通知，非扩展锁。\n如果有1000个客户端同时要获得锁文件，为1000个客户端分发锁所需要的时间也是O(n^2)\n。因为每一次锁文件的释放，所有剩下的客户端都会收到WATCH的通知，并且回到循环的开始，再次尝试创建锁文件。")]),t._v(" "),e("p",[t._v("创建可扩展锁")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('CREATE("f", data, sequential=TRUE, ephemeral=TRUE)\nWHILE TRUE:\n    LIST("f*")\n    IF NO LOWER #FILE: RETURN\n    IF EXIST(NEXT LOWER #FILE, watch=TRUE):\n        WAIT\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])])])}),[],!1,null,null,null);e.default=s.exports}}]);